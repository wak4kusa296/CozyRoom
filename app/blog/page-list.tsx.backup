import { redirect } from 'next/navigation'
import { getCurrentUser } from '@/libs/auth'
import { signOut } from '../actions/auth'
import { getArticles } from '@/libs/microcms'
import Link from 'next/link'
import { AnimatedCard } from './components/AnimatedCard'
import { FadeInText } from '../components/ui/motion'

export default async function BlogPage() {
  const user = await getCurrentUser()
  
  if (!user) {
    redirect('/')
  }

  let articles
  let errorMessage: string | null = null
  
  try {
    const response = await getArticles(20, 0)
    articles = response.contents
  } catch (error) {
    console.error('Error fetching articles:', error)
    articles = []
    errorMessage = error instanceof Error ? error.message : '記事の取得に失敗しました'
  }

  return (
    <div className="min-h-screen bg-sys-bg-base text-sys-text-primary">
      <div className="max-w-grid mx-auto p-16">
        <div className="grid-mobile md:grid-tablet lg:grid-desktop">
          <header className="col-span-4 md:col-span-8 lg:col-span-12 border-b border-sys-border-hairline pb-6 mb-section flex justify-between items-center">
            <FadeInText>
              <h1 className="text-h1 whitespace-nowrap text-sys-text-primary text-shadow-acrylic">誰も知らない部屋</h1>
            </FadeInText>
            <div className="flex items-center gap-component">
              <span className="text-p text-sys-text-secondary">{user.name}さん</span>
              <form action={signOut}>
                <button
                  type="submit"
                  className="text-p border border-sys-border-hairline text-sys-text-primary px-4 py-2 hover:border-sys-border-focus active:translate-x-px active:translate-y-px transition-all duration-200 rounded-xs focus-visible:ring-2 focus-visible:ring-sys-border-focus focus-visible:ring-offset-2"
                >
                  ログアウト
                </button>
              </form>
            </div>
          </header>
          
          <main className="col-span-4 md:col-span-8 lg:col-start-4 lg:col-span-6 space-y-section">
            <FadeInText staggerDelay={0.1}>
              <h2 className="text-h2 whitespace-nowrap text-sys-text-primary border-b border-sys-border-hairline pb-3 text-shadow-acrylic">記事一覧</h2>
            </FadeInText>
            
            {errorMessage ? (
              <div className="relative bg-sys-bg-surface p-6 space-y-component rounded-xs shadow-drop before:absolute before:inset-0 before:bg-sys-bg-paper before:-z-10 before:translate-x-1 before:translate-y-1 before:rounded-xs">
                <p className="text-p text-sys-text-primary border-b-2 border-sys-border-focus">エラーが発生しました</p>
                <p className="text-p text-sys-text-secondary whitespace-pre-wrap">{errorMessage}</p>
                <p className="text-p text-sys-text-secondary">
                  MicroCMSの設定を確認してください：
                  <br />- 環境変数 MICROCMS_SERVICE_DOMAIN と MICROCMS_API_KEY が正しく設定されているか
                  <br />- MicroCMSでAPIエンドポイント名が "blog" になっているか
                </p>
              </div>
            ) : articles.length === 0 ? (
              <p className="text-p text-sys-text-secondary">記事がありません。</p>
            ) : (
              <div className="bg-sys-bg-paper p-6 rounded-xs shadow-inner-deboss">
                <ul className="space-y-component">
                  {articles.map((article, index) => (
                    <AnimatedCard key={article.id} article={article} index={index} />
                  ))}
                </ul>
              </div>
            )}
          </main>
        </div>
      </div>
    </div>
  )
}

